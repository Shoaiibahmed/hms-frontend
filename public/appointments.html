<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appointment Services</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
   <a class="navbar-brand" href="index.html">üè• HMS</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="#">Appointments</a></li>
        <li class="nav-item"><a class="nav-link text-warning" href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
  <h3 class="text-primary mb-4">Book an Appointment</h3>

  <form id="appointmentForm" class="row g-3 mb-5">
    <div class="col-md-3"><input type="text" class="form-control" id="doctor" placeholder="Doctor" required></div>
    <div class="col-md-3"><input type="text" class="form-control" id="department" placeholder="Department" required></div>
    <div class="col-md-2"><input type="date" class="form-control" id="date" required></div>
    <div class="col-md-2"><input type="time" class="form-control" id="time" required></div>
    <div class="col-md-2"><input type="text" class="form-control" id="reason" placeholder="Reason" required></div>
    <div class="col-md-12 text-end"><button class="btn btn-success">Book</button></div>
  </form>

  <h4 class="text-primary">My Appointments</h4>
  <table class="table table-bordered bg-white shadow-sm">
    <thead class="table-primary">
      <tr>
        <th>Doctor</th>
        <th>Department</th>
        <th>Date</th>
        <th>Time</th>
        <th>Reason</th>
          <th>Status</th> <!-- NEW -->
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="appointmentTable"></tbody>
  </table>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="updateForm">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Update Appointment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="updateId">
        <div class="mb-3"><label>Date</label><input type="date" id="updateDate" class="form-control"></div>
        <div class="mb-3"><label>Time</label><input type="time" id="updateTime" class="form-control"></div>
        <div class="mb-3"><label>Reason</label><input type="text" id="updateReason" class="form-control"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success">Save</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  const token = localStorage.getItem('token');

  async function fetchAppointments() {
    const res = await fetch('http://localhost:3104/api/appointments/my', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const appointments = await res.json();
    const table = document.getElementById('appointmentTable');
    table.innerHTML = '';
    appointments.forEach(app => {
      table.innerHTML += `
        <tr>
          <td>${app.doctor}</td>
          <td>${app.department}</td>
          <td>${app.date}</td>
          <td>${app.time}</td>
          <td>${app.reason}</td>
           <td>
        ${app.status === 'cancelled' 
          ? '<span class="badge bg-danger">Cancelled</span>' 
          : '<span class="badge bg-success">Booked</span>'}
      </td>
      
          <td>
            <button class="btn btn-sm btn-warning" onclick='editAppointment(${JSON.stringify(app)})'>Edit</button>
            <button class="btn btn-sm btn-danger" onclick='deleteAppointment("${app._id}")'>Delete</button>
          </td>
        </tr>`
    });
  }

  document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      doctor: document.getElementById('doctor').value,
      department: document.getElementById('department').value,
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      reason: document.getElementById('reason').value
    };
    const res = await fetch('http://localhost:3104/api/appointments/book', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      e.target.reset();
      fetchAppointments();
    } else {
      alert('Failed to book.');
    }
  });

  function editAppointment(app) {
    document.getElementById('updateId').value = app._id;
    document.getElementById('updateDate').value = app.date;
    document.getElementById('updateTime').value = app.time;
    document.getElementById('updateReason').value = app.reason;
    new bootstrap.Modal(document.getElementById('updateModal')).show();
  }

  document.getElementById('updateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('updateId').value;
    const payload = {
      time: document.getElementById('updateTime').value,
      reason: document.getElementById('updateReason').value
    };
    const res = await fetch(`http://localhost:3104/api/appointments/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
      fetchAppointments();
    } else {
      alert('Update failed.');
    }
  });

  async function deleteAppointment(id) {
    if (!confirm('Delete appointment?')) return;
    const res = await fetch(`http://localhost:3104/api/appointments/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.ok) fetchAppointments();
    else alert('Delete failed');
  }

  function logout() {
    localStorage.removeItem('token');
    window.location.href = 'login.html';
  }

  fetchAppointments();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
